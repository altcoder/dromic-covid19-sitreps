# This is a basic workflow to help you get started with Actions

name: Airflow/DAG

# Controls when the action will run. Triggers the workflow on push or pull request 
# events but only for the master branch
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  airflow:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      
    - name: Set up Python
      uses: actions/setup-python@v1
      with:
        python-version: '3.7' 

    - uses: actions/setup-java@v1
      with:
        java-version: '9.0.4' 

    - name: Run pip install
      run: |
        pip install -r requirements-airflow.txt
        pip install -r requirements.txt
        
    - name: Configure Airflow
      run: |
        export AIRFLOW_HOME=${{ GITHUB.workspace }}
        airflow upgradedb
        airflow variables -s ENVIRONMENT TEST
        airflow variables -s S3_BUCKET ${{ secrets.AWS_S3_BUCKET }}
        airflow variables -s S3_PATH ${{ secrets.AWS_S3_PATH }}
        airflow variables -s AWS_ACCESS_KEY_ID ${{ secrets.AWS_ACCESS_KEY_ID }}
        airflow variables -s AWS_SECRET_ACCESS_KEY ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        airflow variables -s SNOWFLAKE_CONNECTION SNOWFLAKE_COVID
        airflow connections -a --conn_id SNOWFLAKE_COVID --conn_type snowflake --conn_host ${{ secrets.SNOWFLAKE_HOST }} --conn_login ${{ secrets.SNOWFLAKE_USERNAME }} --conn_password '${{ secrets.SNOWFLAKE_PASSWORD }}' --conn_schema PUBLIC --conn_extra '{ "account": "${{ secrets.SNOWFLAKE_ACCOUNT }}", "warehouse": "COVID_WH", "database": "COVID", "region": "ap-southeast-1", "role": "${{ secrets.SNOWFLAKE_ROLE }}" }'
        airflow connections -l
        airflow list_dags

    - name: Run DAG tests
      run: |
        export AIRFLOW_HOME=${{ GITHUB.workspace }}
        export ENVIRONMENT=CI
        for i in $AIRFLOW_HOME/notebooks/* ; do
          load=`basename $i`;
          load=$(echo "$load" | sed 's/\.[^.]*$//');
          airflow test etl_$load execute_notebook 2020-04-04;
          airflow test etl_$load upload_to_s3 2020-04-04;
          airflow test etl_$load upload_to_snowflake 2020-04-04;
          done
        airflow test github_poll_trigger check_commits_fromic_covid19_sitreps 2020-04-04
